```mermaid
flowchart TD
    %% 样式定义
    classDef dataPrepare fill:#e6f7ff,stroke:#1890ff,stroke-width:1px;  % 数据准备：浅蓝色
    classDef modelOpt fill:#f0f9ff,stroke:#40a9ff,stroke-width:1px;    % 模型优化：淡蓝色
    classDef dbBuild fill:#e6f7ff,stroke:#1890ff,stroke-width:1px;     % 双库构建：浅蓝色
    classDef cluster fill:#fff2e6,stroke:#fa8c16,stroke-width:1px;     % 社区聚类：橙色
    classDef retrieval fill:#f6ffed,stroke:#52c41a,stroke-width:1px;   % RAG检索：浅绿色
    classDef increment fill:#fff2f0,stroke:#ff4d4f,stroke-width:1px;   % 增量优化：淡红色

    %% 1. 数据准备阶段（论文原始数据）
    A[论文原始数据<br/><small>• 标注文本（350句）<br/>• 实体BIO标注<br/>• 三元组（633条）</small>]:::dataPrepare --> B[数据预处理<br/><small>• 术语归一化（论文2.1节）<br/>• 实体标签对齐<br/>• 三元组去重</small>]:::dataPrepare

    %% 2. BERT对比学习优化（核心：提升向量区分度）
    B --> C[BERT对比学习微调<br/><small>• 预训练任务：MLM + 三元组语义对比<br/>• 损失函数：动态焦点损失（论文3.1节）<br/>• 输出：对比学习BERT模型</small>]:::modelOpt

    %% 3. 双库构建（FAISS向量库 + Neo4j图库）
    C --> D1[FAISS向量库构建<br/><small>• 输入：三元组语义单元 + 对比学习BERT<br/>• 操作：向量编码（768维）+ L2归一化<br/>• 输出：FAISS向量索引（含Triple_ID元数据）</small>]:::dbBuild
    B --> D2[Neo4j图库构建<br/><small>• 输入：结构化三元组（实体+关系）<br/>• 操作：实体/关系存储 + Triple_ID字段<br/>• 输出：Neo4j图索引（实体-关系网络）</small>]:::dbBuild

    %% 4. 社区聚类（双库初建后、首次检索前）
    D1 --> E1[提取FAISS向量相似度<br/><small>• 操作：计算三元组向量pairwise相似度<br/>• 输出：高语义关联三元组对（≥0.7）</small>]:::cluster
    D2 --> E2[提取Neo4j实体-关系<br/><small>• 操作：Cypher导出共享实体的三元组<br/>• 输出：高结构关联三元组对</small>]:::cluster
    E1 & E2 --> F[构建结构-语义融合加权图<br/><small>• 节点：Triple_ID（三元组）<br/>• 边：语义关联（权重=相似度×0.8）+ 结构关联（权重=1.0）</small>]:::cluster
    F --> G[Louvain社区聚类<br/><small>• 操作：自动划分社区（≥5条三元组/社区）<br/>• 输出：社区结果（如“连铸缺陷社区”）</small>]:::cluster

    %% 5. 社区结果同步双库（支撑检索）
    G --> H1[FAISS添加社区元数据<br/><small>• 操作：向量元数据新增community_id<br/>• 输出：含社区信息的FAISS索引</small>]:::dbBuild
    G --> H2[Neo4j添加社区属性<br/><small>• 操作：三元组关系新增community_id<br/>• 输出：含社区信息的Neo4j图</small>]:::dbBuild

    %% 6. RAG检索流程（首次检索及后续）
    I[用户查询<br/><small>例：“连铸表面裂纹的原因”</small>]:::retrieval --> J[查询预处理<br/><small>• 实体识别（对比学习BERT-CNNs-Span）<br/>• 意图标签：因果查询<br/>• 输出：查询向量 + 目标实体（连铸/PRO、表面裂纹/PHE）</small>]:::retrieval
    J --> K[社区粗筛（FAISS）<br/><small>• 输入：查询向量 + community_id<br/>• 操作：检索Top-2相关社区的中心向量<br/>• 输出：目标社区（如“连铸缺陷社区”）</small>]:::retrieval
    K --> L1[FAISS向量精筛<br/><small>• 范围：仅目标社区内的三元组向量<br/>• 操作：检索Top-5高相似向量<br/>• 输出：候选三元组ID（Triple_ID）</small>]:::retrieval
    K --> L2[Neo4j图精筛<br/><small>• 范围：目标社区内的实体-关系<br/>• 操作：Cypher查询“CAU→导致→PHE”关系<br/>• 输出：关联三元组（含实体/关系详情）</small>]:::retrieval
    L1 & L2 --> M[知识融合<br/><small>• 去重：剔除重复三元组<br/>• 排序：按相似度+结构关联度加权<br/>• 输出：结构化知识块</small>]:::retrieval
    M --> N[专业回答生成<br/><small>• 框架：结论+分点（原因→措施）<br/>• 校准：钢铁术语归一化<br/>• 输出：带社区来源的回答</small>]:::retrieval

    %% 7. 增量优化闭环（新增数据维护）
    O[用户反馈/新增数据<br/><small>• 纠错：如“漏结晶器漏水→裂纹”<br/>• 补充：新三元组/实体</small>]:::increment --> P[新增数据处理<br/><small>• 人工审核：领域专家确认<br/>• 格式对齐：适配现有三元组结构<br/>• 输出：新增三元组+向量（对比学习BERT编码）</small>]:::increment
    P --> Q[增量社区分配<br/><small>• 操作：计算新增向量与社区中心向量的相似度<br/>• 输出：分配到已有社区/新建社区</small>]:::increment
    Q --> R1[FAISS增量更新<br/><small>• 操作：新增向量+community_id导入索引<br/>• 输出：更新后的FAISS索引</small>]:::increment
    Q --> R2[Neo4j增量更新<br/><small>• 操作：Cypher新增三元组+community_id<br/>• 输出：更新后的Neo4j图</small>]:::increment
    R1 --> D1;  % 新增向量回灌FAISS
    R2 --> D2;  % 新增三元组回灌Neo4j
```