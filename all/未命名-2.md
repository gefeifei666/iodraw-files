```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#f0f7ff', 'edgeLabelBackground':'#ffffff', 'fontFamily': 'Arial, sans-serif', 'nodeBorder': '#1890ff', 'clusterBkg': '#e6f7ff'}}}%%
flowchart TB
    %% =============== 阶段一：知识图谱构建（离线预处理） ===============
    subgraph 阶段一：知识图谱构建
        direction TB
        A([开始]) --> B[文档输入]
        B --> C[文本清洗 + 术语消歧]
        C --> D[实体识别与关系抽取]
        D --> E[图结构构建]
        E --> F[图索引增强]
        F --> G[图数据库 & 向量索引就绪]
        style 阶段一：知识图谱构建 fill:#e6f7ff,stroke:#1890ff,stroke-width:2px
    end

    %% =============== 阶段二：在线查询推理 ===============
    subgraph 阶段二：在线查询推理
        direction TB
        G --> H[用户输入自然语言查询]
        H --> I[查询解析与意图识别]
        I --> J[语义向量化检索]
        I --> K[结构化图遍历检索]
        J --> L[FAISS Top-K]
        K --> M[Neo4j k-hop]
        L --> N[融合重排]
        M --> N
        N --> O[证据精炼与验证]
        O --> P{证据充分可靠？}
        P -->|是| Q[证据整合与推理生成]
        P -->|否| R[扩展检索]
        R --> J
        R --> K
        Q --> S[结果校验与返回]
        S --> T{校验通过？}
        T -->|是| U[返回答案 + 引用证据]
        T -->|否| V[回退机制]
        V --> W[降级为传统RAG 或 返回“无法确定”]
        U --> X([结束])
        W --> X
        style 阶段二：在线查询推理 fill:#f6ffed,stroke:#52c41a,stroke-width:2px
    end

    %% =============== 关键约束标注 ===============
    classDef constraint fill:#fff7e6,stroke:#faad14,stroke-width:1.5px;
    class O,R,V constraint;
    linkStyle 10,11,12 stroke:#faad14,stroke-width:2px,stroke-dasharray:5 5;
    classDef note fill:#f9f0ff,stroke:#722ed3;
    class P,T note;
    
    %% =============== 图例 ===============
    subgraph 图例
        direction LR
        A1[动作/处理]:::action
        A2[数据/存储]:::data
        A3[决策点]:::decision
        A4[设计约束]:::constraint
        A5[关键决策]:::note
    end

    classDef action fill:#1890ff,stroke:#0050b3,color:#ffffff;
    classDef data fill:#00a896,stroke:#006d6d,color:#ffffff;
    classDef decision fill:#faad14,stroke:#d48806,color:#000000;
    classDef constraint fill:#fff7e6,stroke:#faad14,stroke-width:1.5px;
    classDef note fill:#f9f0ff,stroke:#722ed3;
    
    %% =============== 样式定义 ===============
    class A,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,A13,A14,A15,A16,A17,A18,A19,A20,A21,A22,A23,A24,A25,A26,A27,A28,A29,A30,A31,A32,A33,A34,A35,A36,A37,A38,A39,A40,A41,A42,A43,A44,A45,A46,A47,A48,A49,A50,A51,A52,A53,A54,A55,A56,A57,A58,A59,A60,A61,A62,A63,A64,A65,A66,A67,A68,A69,A70,A71,A72,A73,A74,A75,A76,A77,A78,A79,A80,A81,A82,A83,A84,A85,A86,A87,A88,A89,A90,A91,A92,A93,A94,A95,A96,A97,A98,A99,A100 action;
    class B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X data;
    class P,T decision;
    class O,R,V constraint;
    class P,T note;
    
    %% =============== 关键约束说明 ===============
    click O "※ 证据质量门控：一致性检查/可信度评估/相关性过滤" _blank
    click R "※ 自适应扩展：放宽约束/生成新提示（≤2次迭代）" _blank
    click V "※ 回退机制：降级RAG或明确拒绝" _blank
    click P "※ 证据充分性：必须覆盖问题维度且逻辑自洽" _blank
    click T "※ 强制引用：答案必须关联证据链" _blank

```